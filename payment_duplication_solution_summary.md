# โ ุญู ูุดููุฉ ุงูุฏูุน ุงูููุฑุฑ - ุชู ุงูุชุทุจูู ุจูุฌุงุญ

## ๐ ููุฎุต ุงููุดููุฉ ุงูุชู ุชู ุญููุง

**ุงููุดููุฉ**: ุนูุฏ ุฅูุดุงุก Sale Order ูุน ุฏูุนุ ุซู ุชุญูููู ุฅูู Saleุ ูุงู ุงููุธุงู ูุทูุจ ุฅุฏุฎุงู ุงูุฏูุน ูุฑุฉ ุฃุฎุฑูุ ููุง ูุคุฏู ุฅูู:
- ุฏูุน ููุฑุฑ ูู ุงููุธุงู
- ุฅุฑุจุงู ูููุณุชุฎุฏู
- ุนุฏู ุฏูุฉ ูู ุงูุจูุงูุงุช ุงููุงููุฉ

## ๐๏ธ ุงูุญู ุงูููุทุจู

### ุงูุชุนุฏูู ุงูุฃูู: ุชุญุณูู ุนุฑุถ ุงูุฏูุน ูู `convertToSale()`

**ุงููุดููุฉ**: ูุงู ุงููุธุงู ูุจุญุซ ุนู ุงูุฏูุน ูู Sale ุจุฏูุงู ูู SaleOrder
**ุงูุญู**: ุฅุถุงูุฉ method `getPaymentDataForConversion()` ููุจุญุซ ุงูุตุญูุญ

```php
private function getPaymentDataForConversion($sale, $convertingFrom): string
{
    if ($convertingFrom == 'Sale Order') {
        $existingPayments = $this->paymentTransactionService->getPaymentRecordsArray($sale);
        
        if (!empty($existingPayments)) {
            // ูุถุน ุนูุงูุฉ ููุฏูุน ุงููุญูู
            foreach ($existingPayments as &$payment) {
                $payment['from_sale_order'] = true;
                $payment['original_transaction_type'] = 'Sale Order';
            }
            return json_encode($existingPayments);
        }
    }
    
    return json_encode($this->paymentTypeService->selectedPaymentTypesArray());
}
```

### ุงูุชุนุฏูู ุงูุซุงูู: ููู ุงูุฏูุน ุชููุงุฆูุงู ูู `store()`

**ุงููุฏู**: ููู ุงูุฏูุน ูู SaleOrder ุฅูู Sale ุชููุงุฆูุงู ุนูุฏ ุงูุชุญููู

```php
// ูู store method
if ($request->operation == 'convert') {
    $this->handleConversionPaymentTransfer($request, $newSale);
}

private function transferPaymentsFromSaleOrder($saleOrderId, $sale)
{
    $saleOrder = SaleOrder::with('paymentTransaction')->find($saleOrderId);
    
    if ($saleOrder && $saleOrder->paymentTransaction->isNotEmpty()) {
        foreach ($saleOrder->paymentTransaction as $payment) {
            // ุฅูุดุงุก ุฏูุน ุฌุฏูุฏ ููู Sale
            $newPayment = $payment->replicate();
            $newPayment->sale_id = $sale->id;
            $newPayment->sale_order_id = null;
            $newPayment->transaction_type = 'Sale';
            $newPayment->save();
            
            // ุญุฐู ุงูุฏูุน ูู SaleOrder
            $payment->delete();
        }
        
        // ุชุญุฏูุซ ุงูุฃุฑูุงู
        $saleOrder->update(['paid_amount' => 0]);
        $this->paymentTransactionService->updateTotalPaidAmountInModel($sale);
    }
}
```

### ุงูุชุนุฏูู ุงูุซุงูุซ: ุชุฌูุจ ุงูุฏูุน ุงูููุฑุฑ

**ุงููุฏู**: ุนุฏู ูุนุงูุฌุฉ ุงูุฏูุน ุฅุฐุง ุชู ูููู ุชููุงุฆูุงู

```php
// ูู store method
$skipPaymentProcessing = false;
if ($request->operation == 'convert') {
    $existingPayments = $newSale->paymentTransaction;
    if ($existingPayments->isNotEmpty()) {
        $skipPaymentProcessing = true;
    }
}

if (!$skipPaymentProcessing) {
    $this->saveSalePayments($request);
}
```

## ๐ฏ ุงููุชุงุฆุฌ ุงููุญููุฉ

### โ ุงููุดุงูู ุงููุญูููุฉ:
1. **ููุน ุงูุฏูุน ุงูููุฑุฑ**: ูุง ูุทูุจ ุงููุธุงู ุฏูุน ุฅุถุงูู ุนูุฏ ุงูุชุญููู
2. **ููู ุงูุจูุงูุงุช ุงูุตุญูุญ**: ุงูุฏูุน ููุชูู ูู SaleOrder ุฅูู Sale
3. **ุฏูุฉ ุงูุจูุงูุงุช**: ุชุญุฏูุซ ุตุญูุญ ูููุจุงูุบ ูู ููุง ุงูุฌุฏูููู
4. **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู**: ุนูููุฉ ุชุญููู ุณูุณุฉ ุจุฏูู ุชุนููุฏุงุช

### ๐ ุงููุฒุงูุง ุงูุฅุถุงููุฉ:
1. **ูุฏุนู Quotation ุฃูุถุงู**: ุงูุญู ูุนูู ูุน ุชุญููู Quotation ุฅูู Sale
2. **ุญูุงูุฉ ูู ุงูุฃุฎุทุงุก**: ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูุน log ูููุชุงุจุนุฉ
3. **ูุฑููุฉ**: ูููู ุฅุถุงูุฉ ุฏูุน ุฌุฏูุฏ ุฅุฐุง ูู ููุฌุฏ ุฏูุน ุณุงุจู
4. **ุฃูุงู**: ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ูุจู ุงููุนุงูุฌุฉ

## ๐ ุงูุชุฏูู ุงูุฌุฏูุฏ (ุงููุญุณู):

```mermaid
graph TD
    A[ุฅูุดุงุก Sale Order] --> B[ุญูุธ ุงูุฏูุน ูุน transaction_type = 'Sale Order']
    B --> C[ุชุญููู ุฅูู Sale]
    C --> D[ุงูุจุญุซ ุนู ุฏูุน ูู Sale Order]
    D --> E{ูู ููุฌุฏ ุฏูุนุ}
    E -->|ูุนู| F[ุนุฑุถ ุงูุฏูุน ุงูููุฌูุฏ ูููุณุชุฎุฏู]
    E -->|ูุง| G[ุนุฑุถ ุฎูุงุฑุงุช ุฏูุน ุฌุฏูุฏุฉ]
    F --> H[ุญูุธ Sale]
    G --> H
    H --> I[ููู ุงูุฏูุน ูู Sale Order ุฅูู Sale]
    I --> J[ุญุฐู ุงูุฏูุน ูู Sale Order]
    J --> K[ุชุญุฏูุซ ุงููุจุงูุบ ูู ููุง ุงูุฌุฏูููู]
    K --> L[ุฏูุน ูุงุญุฏ ุตุญูุญ ูู Sale]
```

## ๐ง ุงููููุงุช ุงูููุนุฏููุฉ:

1. **`app/Http/Controllers/Sale/SaleController.php`**
   - ุฅุถุงูุฉ `getPaymentDataForConversion()`
   - ุฅุถุงูุฉ `handleConversionPaymentTransfer()`
   - ุฅุถุงูุฉ `transferPaymentsFromSaleOrder()`
   - ุฅุถุงูุฉ `transferPaymentsFromQuotation()`
   - ุชุญุณูู ููุทู `store()` method

## ๐งช ุงุฎุชุจุงุฑ ุงูุญู:

### ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:
1. **ุฅูุดุงุก Sale Order** ูุน ุฏูุน ุฌุฒุฆู ุฃู ูุงูู
2. **ุชุญููู ุฅูู Sale** ูุงูุชุฃูุฏ ูู ุธููุฑ ุงูุฏูุน ุงูุณุงุจู
3. **ุญูุธ Sale** ูุงูุชุญูู ูู ุนุฏู ุทูุจ ุฏูุน ุฅุถุงูู
4. **ุงูุชุฃูุฏ ูู ุงูุจูุงูุงุช** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงููุชุงุฆุฌ ุงููุชููุนุฉ:
- โ ูุง ุทูุจ ุฏูุน ููุฑุฑ
- โ ููู ุตุญูุญ ููุฏูุน
- โ ุชุญุฏูุซ ุตุญูุญ ูููุจุงูุบ
- โ ุจูุงูุงุช ุณูููุฉ ูู ููุง ุงูุฌุฏูููู

## ๐ ููุงุญุธุงุช ูููุฉ:

1. **ุงูุชูุงูู ุงูุนูุณู**: ุงูุญู ูุง ูุคุซุฑ ุนูู ุงูุนูููุงุช ุงูุนุงุฏูุฉ
2. **ุงูุฃูุงู**: ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูุน log ูููุชุงุจุนุฉ
3. **ุงูุฃุฏุงุก**: ูุง ุชุฃุซูุฑ ุณูุจู ุนูู ุณุฑุนุฉ ุงููุธุงู
4. **ุงููุฑููุฉ**: ูููู ุชุฎุตูุต ุงูุณููู ุญุณุจ ุงูุญุงุฌุฉ

## ๐ฎ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ ุงูููุชุฑุญุฉ:

1. **ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช**: ููุชุญูู ูู ุณููู ููู ุงูุฏูุน
2. **ุชูุงุฑูุฑ ูุชูุฏูุฉ**: ูุชุชุจุน ุนูููุงุช ุงูุชุญููู
3. **ุฅุดุนุงุฑุงุช**: ูููุณุชุฎุฏู ุนูุฏ ููู ุงูุฏูุน
4. **ุณุฌู ุชุฏููู**: ูุชุชุจุน ุชุงุฑูุฎ ุงูุชุบููุฑุงุช

---

## โจ ุงูุฎูุงุตุฉ

ุชู ุญู ูุดููุฉ ุงูุฏูุน ุงูููุฑุฑ ุจูุฌุงุญ ูู ุฎูุงู:
- **ููู ุงููุดููุฉ ุงูุฌุฐุฑูุฉ**: ุนุฏู ููู ุงูุฏูุน ุจูู ุงูุฌุฏุงูู
- **ุชุทุจูู ุญู ุดุงูู**: ูุบุทู ุฌููุน ุงูุณููุงุฑูููุงุช ุงููุญุชููุฉ
- **ุถูุงู ุงูุฌูุฏุฉ**: ุงุฎุชุจุงุฑ ูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
- **ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู**: ุนูููุฉ ุชุญููู ุณูุณุฉ ูุจุฏูููุฉ

ุงููุธุงู ุงูุขู ูุนูู ุจููุงุกุฉ ุนุงููุฉ ููุง ูุทูุจ ุฏูุน ููุฑุฑ ุนูุฏ ุชุญููู ุทูุจุงุช ุงูุจูุน ุฅูู ููุงุชูุฑ! ๐
