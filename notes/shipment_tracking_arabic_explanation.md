# تحليل نظام تتبع الشحن لطلبات البيع

## 1. نظرة عامة على البنية

نظام تتبع الشحن في تطبيقك يتبع هيكلية مرنة تسمح لكل طلب بيع بالحصول على عدة سجلات تتبع شحن، وكل سجل تتبع يمكن أن يحتوي على عدة أحداث. هذا التصميم يوفر مرونة كبيرة في إدارة الشحنات.

### 1.1 العلاقات الأساسية

#### علاقة طلب البيع مع تتبع الشحن
- **نوع العلاقة**: علاقة واحد إلى كثير (HasMany)
- **النموذج**: [SaleOrder](file:///c%3A/xampp/htdocs/faster_system/app/Models/Sale/SaleOrder.php#L15-L227) → [ShipmentTracking](file:///c%3A/xampp/htdocs/faster_system/app/Models/Sale/ShipmentTracking.php#L15-L112)
- **الوصف**: كل طلب بيع يمكن أن يحتوي على عدة سجلات تتبع شحن

#### علاقة تتبع الشحن مع الأحداث
- **نوع العلاقة**: علاقة واحد إلى كثير (HasMany)
- **النموذج**: [ShipmentTracking](file:///c%3A/xampp/htdocs/faster_system/app/Models/Sale/ShipmentTracking.php#L15-L112) → [ShipmentTrackingEvent](file:///c%3A/xampp/htdocs/faster_system/app/Models/Sale/ShipmentTrackingEvent.php#L15-L77)
- **الوصف**: كل سجل تتبع شحن يمكن أن يحتوي على عدة أحداث

## 2. هيكلية البيانات

### 2.1 جدول طلبات البيع (sale_orders)
- يحتوي على معلومات أساسية عن الطلب
- يرتبط بسجلات تتبع الشحن من خلال معرف الطلب

### 2.2 جدول تتبع الشحن (shipment_trackings)
- يحتوي على معلومات عامة حول عملية التتبع
- **الحقول المهمة**:
  - `sale_order_id`: معرف طلب البيع
  - `carrier_id`: معرف شركة الشحن
  - `tracking_number`: رقم التتبع
  - `status`: الحالة العامة للتتبع
  - `estimated_delivery_date`: التاريخ المتوقع للتسليم
  - `actual_delivery_date`: التاريخ الفعلي للتسليم

### 2.3 جدول أحداث التتبع (shipment_tracking_events)
- يحتوي على تفاصيل كل حدث في رحلة الشحن
- **الحقول المهمة**:
  - `shipment_tracking_id`: معرف سجل التتبع
  - `event_date`: تاريخ ووقت الحدث
  - `location`: موقع الحدث
  - `status`: حالة الحدث
  - `description`: وصف الحدث
  - `proof_image`: صورة إثبات الحدث

## 3. تدفق العملية

### 3.1 إنشاء تتبع الشحن
1. عند إنشاء تتبع شحن جديد، يتم ربطه بطلب بيع محدد
2. يتم تعيين رقم التتبع وشركة الشحن
3. الحالة الأولية تكون عادة "قيد الانتظار"

### 3.2 إضافة أحداث التتبع
1. لكل عملية تتبع، يمكن إضافة عدة أحداث أثناء رحلة الشحن
2. كل حدث يحتوي على:
   - التاريخ والوقت
   - الموقع
   - الحالة
   - الوصف التفصيلي
   - صورة إثبات (اختيارية)

### 3.3 تحديث الحالة العامة
- عند إضافة حدث جديد، يتم تحديث الحالة العامة لسجل التتبع تلقائياً
- في حالة تسليم الشحنة، يتم تحديث التاريخ الفعلي للتسليم

## 4. مثال عملي

### 4.1 سيناريو تتبع الشحن
لطلب بيع واحد (SO-001)، يمكن أن يكون لدينا:

#### سجل تتبع واحد:
- **رقم التتبع**: TRK-123456
- **شركة الشحن**: شركة الشحن السريعة
- **الحالة العامة**: "تم التسليم"
- **التاريخ المتوقع**: 2023-06-20
- **التاريخ الفعلي**: 2023-06-18

#### أحداث التتبع:
1. **الحدث 1**:
   - التاريخ: 2023-06-15 09:00
   - الموقع: مستودع الشركة
   - الحالة: "قيد الانتظار"
   - الوصف: "تم استلام الطرد من المستودع"

2. **الحدث 2**:
   - التاريخ: 2023-06-15 15:30
   - الموقع: مركز الفرز الرئيسي
   - الحالة: "قيد النقل"
   - الوصف: "الطرد في طريقه إلى المدينة"

3. **الحدث 3**:
   - التاريخ: 2023-06-17 11:15
   - الموقع: مركز التوزيع المحلي
   - الحالة: "خارج للتوصيل"
   - الوصف: "الطرد مع مندوب التوصيل"

4. **الحدث 4**:
   - التاريخ: 2023-06-18 14:20
   - الموقع: عنوان العميل
   - الحالة: "تم التسليم"
   - الوصف: "تم تسليم الطرد للعميل"
   - صورة إثبات: [صورة التوقيع]

## 5. فوائد هذا التصميم

### 5.1 المرونة
- يمكن تتبع عدة شحنات لطلب بيع واحد (مفيد للمنتجات الكبيرة التي تحتاج شحنات منفصلة)
- كل شحنة يمكن أن تحتوي على عدة أحداث مفصلة

### 5.2 التتبع التفصيلي
- كل خطوة في رحلة الشحن محفوظة كحدث منفصل
- إمكانية إضافة صور إثبات لكل حدث
- معلومات الموقع والزمان لكل حدث

### 5.3 التحديث التلقائي
- الحالة العامة للشحنة تتحدث تلقائياً عند إضافة أحداث
- التاريخ الفعلي للتسليم يحسب تلقائياً عند تسليم الشحنة

## 6. استخدامات عملية

### 6.1 واجهة المستخدم
- في صفحة تعديل طلب البيع، يظهر قسم خاص بالتتبع
- كل سجل تتبع يظهر مع جميع أحداثه في جدول زمني
- إمكانية إضافة أحداث جديدة بسهولة

### 6.2 الإشعارات
- يمكن إرسال إشعارات للعميل عند كل تحديث في الحالة
- إشعارات داخلية للموظفين عند حدوث أحداث مهمة

### 6.3 التقارير
- تقارير عن أداء شركات الشحن
- تحليل أوقات التسليم
- متابعة الشحنات المتأخرة

## 7. أفضل الممارسات

### 7.1 إضافة الأحداث
- إضافة حدث لكل نقطة مهمة في رحلة الشحن
- استخدام صور إثبات عند التسليم
- تحديث الحالة فور حدوث أي تغيير

### 7.2 صيانة البيانات
- التأكد من صحة أرقام التتبع
- تحديث التواريخ المتوقعة عند حدوث تأخير
- حفظ جميع الأحداث حتى لو كانت بسيطة

## 8. الخلاصة

هذا التصميم يوفر نظام تتبع شحن قوي ومرن يسمح بـ:
1. تتبع عدة شحنات لكل طلب بيع
2. تفاصيل دقيقة لكل حدث في رحلة الشحن
3. تحديث تلقائي للحالات
4. إمكانية إضافة صور إثبات
5. تقارير مفصلة عن أداء الشحن

هذا النظام يساعد في تحسين تجربة العملاء وزيادة الشفافية في عملية التوصيل.
